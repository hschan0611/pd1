{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
    Part {{ subsession.active_game }} - Match {{ subsession.match_number }} - Round {{ subsession.round_in_match_number }}:
    Predict the Other Participant's Action
{% endblock %}

{% block content %}
<h3>Payoff Table (Part {% if subsession.active_game == 1 %}1{% else %}2{% endif %})</h3>
<p>Below is the payoff table. In each cell, the first number is <strong>your</strong> payoff and the second is the <strong>other participant’s</strong> payoff.</p>

<table class="table table-bordered text-center" style="width:auto; margin:auto">
  <tr>
    <th colspan="2" rowspan="2"></th>
    <th colspan="2">The Other Participant</th>
  </tr>
  <tr>
    <th>Action 1</th>
    <th>Action 2</th>
  </tr>

  {% if subsession.active_game == 1 %}
    <!-- Part 1 payoffs -->
    <tr>
      <th rowspan="2">You</th>
      <th>Action 1</th>
      <td>{{ Constants.both_cooperate_payoff_1 }}, {{ Constants.both_cooperate_payoff_1 }}</td>
      <td>{{ Constants.betrayed_payoff_1 }}, {{ Constants.betray_payoff_1 }}</td>
    </tr>
    <tr>
      <th>Action 2</th>
      <td>{{ Constants.betray_payoff_1 }}, {{ Constants.betrayed_payoff_1 }}</td>
      <td>{{ Constants.both_defect_payoff_1 }}, {{ Constants.both_defect_payoff_1 }}</td>
    </tr>
  {% else %}
    <!-- Part 2 payoffs -->
    <tr>
      <th rowspan="2">You</th>
      <th>Action 1</th>
      <td>{{ Constants.both_cooperate_payoff_2 }}, {{ Constants.both_cooperate_payoff_2 }}</td>
      <td>{{ Constants.betrayed_payoff_2 }}, {{ Constants.betray_payoff_2 }}</td>
    </tr>
    <tr>
      <th>Action 2</th>
      <td>{{ Constants.betray_payoff_2 }}, {{ Constants.betrayed_payoff_2 }}</td>
      <td>{{ Constants.both_defect_payoff_2 }}, {{ Constants.both_defect_payoff_2 }}</td>
    </tr>
  {% endif %}
</table>

<h3><strong>Enter Your Belief</strong></h3>
<p>Use the slider to indicate your belief (0–100%) about how likely the other participant is to choose Action 1:</p>

<!-- No extra <form> here; global/Page.html already wraps content in a form -->

<!-- Slider -->
<input
    type="range"
    id="belief-slider"
    name="belief"
    min="0"
    max="100"
    value="{{ belief_value_init }}"
    oninput="updateBeliefValue(this.value)"
    aria-label="Belief that the other participant chooses Action 1 (0–100%)"
    style="width: 80%; height: 30px;"
>

<p>Probability: <span id="belief-value">{{ belief_value_init }}</span>%</p>

<!-- Hidden interaction flag -->
<input type="hidden" name="belief_interacted" id="belief_interacted" value="0">

<!-- Confirmation copy that adapts when user hasn't interacted -->
<div id="confirmation-box" style="display: none; margin-top: 20px;">
  <p id="confirmation-text"><strong>Are you sure this is your final guess?</strong></p>
  <button type="button" class="btn btn-secondary" onclick="hideConfirmation()">No, change my guess</button>
  <!-- This submits the main oTree form -->
  <button type="submit" id="submit-button" class="btn btn-primary">Yes, submit</button>
</div>

<!-- Initial Next Button (does NOT submit) -->
<button type="button" id="next-button" class="btn btn-primary" onclick="confirmBelief()">Next</button>

<script>
  const slider = document.getElementById("belief-slider");
  const valueEl = document.getElementById("belief-value");
  const interactedEl = document.getElementById("belief_interacted");
  const nextBtn = document.getElementById("next-button");
  const confirmBox = document.getElementById("confirmation-box");
  const confirmText = document.getElementById("confirmation-text");

  function markInteracted() {
    interactedEl.value = "1";
  }

  function updateBeliefValue(val) {
    valueEl.textContent = val;
    markInteracted();
  }

  // Mark as interacted on any user action
  ["pointerdown","touchstart","mousedown","keydown","input","change"].forEach(ev => {
    slider.addEventListener(ev, markInteracted, { passive: true });
  });

  function confirmBelief() {
    const sliderValue = slider.value;
    const interacted = interactedEl.value === "1";

    if (!interacted) {
      confirmText.innerHTML =
        "<strong>You haven't adjusted the slider.</strong> " +
        "If this value truly reflects your belief, please confirm below.";
    } else {
      confirmText.textContent = "Are you sure this is your final guess?";
    }

    nextBtn.style.display = "none";
    confirmBox.style.display = "block";
  }

  function hideConfirmation() {
    confirmBox.style.display = "none";
    nextBtn.style.display = "inline-block";
  }
</script>

{% endblock %}
