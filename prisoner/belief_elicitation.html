{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
    Predict the Other Participant's Move
{% endblock %}

{% block content %}

<p>Now, you will have one more task. In each round of a match, after you make your choice and before seeing the results, we will ask you to report your belief about the other participant’s choice (Action 1 or Action 2).</p>

<p>To indicate your belief, use the slider below. The slider value represents your belief (as a percentage) that the other participant will choose <strong>Action 1</strong>.</p>

<h4>Examples</h4>
<ul>
  <li><strong>60%</strong>: You believe the other participant has a <strong>60% chance</strong> of selecting Action 1 (and a <strong>40% chance</strong> of selecting Action 2).</li>
  <li><strong>30%</strong>: You believe the other participant has a <strong>30% chance</strong> of selecting Action 1 (and a <strong>70% chance</strong> of selecting Action 2).</li>
</ul>

<h4>Payment and Accuracy</h4>
<p>Your payment depends on the accuracy of your answer. You have the highest chance of winning the prize when you report your <strong>true belief</strong> about how likely the other participant is to choose Action 1 or Action 2.</p>

<p>Your belief report does not affect anyone else’s decisions and is not shown to other participants.</p>

<h4>(Optional) How the Payment Works</h4>
<p>If you are interested, here is how your belief submission affects your payment:</p>
<ul>
  <li>The computer randomly draws two numbers between 0 and 100. Draws are independent in the sense that the outcome of the first draw in no way affects the outcome of the second draw.</li>
  <li>If the person you are paired with chose 1 in that round and the number you indicated as the likelihood that the other chose 1 is larger than either of the two draws, you earn the <strong>8-point prize</strong>; otherwise you earn 0 points.</li>
  <li>If the person you are paired with chose 2 in that round and the number you indicated as the likelihood that the other chose 2 is larger than either of the two draws, you earn the <strong>8-point prize</strong>; otherwise you earn 0 points.</li>
</ul>

<hr>

<h3>Current Game Payoff Matrix (Game{% if subsession.active_game == 1 %}1{% else %}2{% endif %})</h3>
<p><em>In each cell, the first number is <strong>your</strong> payoff and the second number is your <strong>opponent’s</strong> payoff.</em></p>

<table class="table table-bordered text-center" style="max-width:600px">
  <thead>
    <tr>
      <th rowspan="2" class="align-middle">You \ Other</th>
      <th colspan="2">Other's Action</th>
    </tr>
    <tr>
      <th>Action 1</th>
      <th>Action 2</th>
    </tr>
  </thead>
  <tbody>
    {% if subsession.active_game == 1 %}
      <tr>
        <th>Action 1</th>
        <td>({{ Constants.both_cooperate_payoff_1 }}, {{ Constants.both_cooperate_payoff_1 }})</td>
        <td>({{ Constants.betrayed_payoff_1 }}, {{ Constants.betray_payoff_1 }})</td>
      </tr>
      <tr>
        <th>Action 2</th>
        <td>({{ Constants.betray_payoff_1 }}, {{ Constants.betrayed_payoff_1 }})</td>
        <td>({{ Constants.both_defect_payoff_1 }}, {{ Constants.both_defect_payoff_1 }})</td>
      </tr>
    {% else %}
      <tr>
        <th>Action 1</th>
        <td>({{ Constants.both_cooperate_payoff_2 }}, {{ Constants.both_cooperate_payoff_2 }})</td>
        <td>({{ Constants.betrayed_payoff_2 }}, {{ Constants.betray_payoff_2 }})</td>
      </tr>
      <tr>
        <th>Action 2</th>
        <td>({{ Constants.betray_payoff_2 }}, {{ Constants.betrayed_payoff_2 }})</td>
        <td>({{ Constants.both_defect_payoff_2 }}, {{ Constants.both_defect_payoff_2 }})</td>
      </tr>
    {% endif %}
  </tbody>
</table>

<h3>Enter Your Belief</h3>
<p>Use the slider to indicate your belief (0-100%) about how likely the other participant is to choose Action 1:</p>

<form method="post" id="belief-form">
  <!-- Slider -->
  <input
    type="range"
    id="belief-slider"
    name="belief"
    min="0" max="100"
    value="{{ player.field_maybe_none('belief') or 50 }}"
    oninput="updateBeliefValue(this.value)"
    aria-label="Belief that the other participant chooses Action 1 (0–100%)"
  >

  <p>Probability: <span id="belief-value">{{ player.field_maybe_none('belief') or 50 }}</span>%</p>

  <!-- Hidden interaction flag -->
  <input type="hidden" name="belief_interacted" id="belief_interacted" value="0">

  <!-- Confirmation copy that adapts when user hasn't interacted -->
  <div id="confirmation-box" style="display: none; margin-top: 20px;">
    <p id="confirmation-text"><strong>Are you sure this is your final guess?</strong></p>
    <button type="button" class="btn btn-secondary" onclick="hideConfirmation()">No, change my guess</button>
    <button type="submit" id="submit-button" class="btn btn-primary">Yes, submit</button>
  </div>

  <!-- Initial Next Button -->
  <button type="button" id="next-button" class="btn btn-primary" onclick="confirmBelief()">Next</button>

</form>

<script>
  const slider = document.getElementById("belief-slider");
  const valueEl = document.getElementById("belief-value");
  const interactedEl = document.getElementById("belief_interacted");
  const nextBtn = document.getElementById("next-button");
  const confirmBox = document.getElementById("confirmation-box");
  const confirmText = document.getElementById("confirmation-text");

  function markInteracted() {
    interactedEl.value = "1";
  }

  function updateBeliefValue(val) {
    valueEl.textContent = val;
    // oninput already implies interaction, but keep explicit flag set:
    markInteracted();
  }

  // Consider *any* user action as interaction, even if value remains 50
  ["pointerdown","touchstart","mousedown","keydown","input","change"].forEach(ev => {
    slider.addEventListener(ev, markInteracted, { passive: true });
  });

  function confirmBelief() {
    const sliderValue = slider.value;           // "0".."100"
    const interacted = interactedEl.value === "1";

    // We never block 50%. If it's still 50% and no interaction,
    // we just show a gentle note in the confirmation box.
    if (!interacted && sliderValue === "50") {
      confirmText.innerHTML =
        "<strong>You haven't adjusted the slider from 50%.</strong> " +
        "If 50% truly reflects your belief, please confirm below.";
    } else {
      confirmText.textContent = "Are you sure this is your final guess?";
    }

    // Show confirmation, hide Next
    nextBtn.style.display = "none";
    confirmBox.style.display = "block";
  }

  function hideConfirmation() {
    confirmBox.style.display = "none";
    nextBtn.style.display = "inline-block";
  }
</script>

{% endblock %}

